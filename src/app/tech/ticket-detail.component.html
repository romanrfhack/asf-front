<div *ngIf="ticket" class="space-y-4">
  <div class="bg-white rounded-xl shadow p-4">
    <div class="flex items-start justify-between">
      <div>
        <div class="text-lg font-semibold">{{ ticket.title }}</div>
        <div class="text-sm text-slate-600">{{ ticket.description }}</div>
        <div class="text-xs text-slate-500 mt-1">
          Status: <b>{{ ticket.status }}</b> • Due: {{ ticket.dueAt | date:'short' }}
        </div>

        <div class="mt-2 text-xs">
          <span *ngIf="ticket.tech?.translated" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200">translated</span>
        </div>

      </div>
      <button (click)="complete()" class="px-4 py-2 rounded bg-emerald-600 text-white">Complete</button>
    </div>
  </div>

  <!-- Check-in -->
  <div class="bg-white rounded-xl shadow p-4">
    <div class="font-medium">Check-in</div>
    <div class="mt-2 flex flex-wrap gap-2">
      <button (click)="checkInGPS()" class="px-3 py-1 rounded border">GPS Check-in</button>
      <button (click)="checkInQR()" class="px-3 py-1 rounded border">Via QR (simulate)</button>
    </div>
    <div class="mt-3 grid gap-2">
      <div *ngFor="let ci of ticket.tech?.checkins || []" class="text-xs text-slate-600">
        • {{ ci.at | date:'short' }} — {{ ci.mode.toUpperCase() }} <span *ngIf="ci.lat">({{ ci.lat }}, {{ ci.lng }})</span>
      </div>
    </div>
  </div>

  <!-- Checklist -->
  <div class="bg-white rounded-xl shadow p-4">
    <div class="font-medium">Checklist</div>
    <div class="mt-2 flex gap-2">
      <input [(ngModel)]="newTask" class="flex-1 rounded border px-3 py-2" placeholder="Add task...">
      <button (click)="addTask()" class="px-3 py-2 rounded bg-slate-900 text-white">Add</button>
    </div>
    <div class="mt-3 grid gap-2">
      <label *ngFor="let c of ticket.tech?.checklist || []" class="flex items-center gap-2 text-sm">
        <input type="checkbox" [checked]="c.done" (change)="toggleTask(c.id)" class="h-4 w-4">
        <span [class.line-through]="c.done">{{ c.text }}</span>
      </label>
    </div>
  </div>

  <!-- Photos -->
  <div class="bg-white rounded-xl shadow p-4">
    <div class="font-medium">Photos</div>
    <input type="file" (change)="onPhotosSelected($event)" accept="image/*" multiple class="mt-2">
    <div class="grid grid-cols-3 gap-2 mt-3">
      <img *ngFor="let p of ticket.photos || []" [src]="p" class="w-full h-24 object-cover rounded">
    </div>
  </div>

  <!-- Parts -->
  <div class="bg-white rounded-xl shadow p-4">
    <div class="font-medium">Parts / Consumables</div>
    <div class="grid gap-2 sm:grid-cols-4 mt-2">
      <input [(ngModel)]="partName" class="rounded border px-3 py-2" placeholder="Part name">
      <input [(ngModel)]="partQty" type="number" min="1" class="rounded border px-3 py-2" placeholder="Qty">
      <input [(ngModel)]="partCost" type="number" min="0" step="0.01" class="rounded border px-3 py-2" placeholder="Unit cost">
      <button (click)="addPart()" class="px-3 py-2 rounded bg-slate-900 text-white">Add</button>
    </div>
    <div class="mt-3 grid gap-2">
      <div *ngFor="let p of ticket.tech?.parts || []" class="flex items-center justify-between text-sm">
        <div>{{ p.name }} — x{{ p.qty }} @ {{ p.unitCost | number:'1.2-2' }}</div>
        <div class="flex items-center gap-3">
          <div class="text-xs text-slate-500">{{ (p.qty * p.unitCost) | number:'1.2-2' }}</div>
          <button (click)="removePart(p.id)" class="text-xs underline">Remove</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Signature & Notes -->
  <div class="bg-white rounded-xl shadow p-4">
    <div class="grid md:grid-cols-2 gap-4">
      <div>
        <div class="font-medium mb-2">Signature</div>
        <signature-pad [existing]="ticket.tech?.signature" (saved)="setSignature($event)"></signature-pad>
      </div>
      <div>
        <div class="font-medium mb-2">Technician Notes</div>
        <textarea [(ngModel)]="notes" rows="8" class="w-full rounded border px-3 py-2"></textarea>
        <div class="pt-2">
          <button (click)="saveNotes()" class="px-3 py-1 rounded border">Save notes</button>
        </div>
        
        <label class="mt-2 inline-flex items-center gap-2 text-xs">
          <input type="checkbox" [checked]="translated" (change)="setTranslated($any($event.target).checked)">
          Mark notes as translated (ES↔EN)
        </label>

      </div>
    </div>
  </div>
</div>
